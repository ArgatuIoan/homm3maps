<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Interactive Hexagonal Grid Tool</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            font-family: Arial, sans-serif;
            overflow: hidden;
            background: url('assets/fog.png') repeat;
        }
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: transparent;
        }
        .controls {
            position: absolute;
            top: 0;
            right: 0;
            width: 300px;
            height: 100%;
            background: url('assets/leather.png') repeat;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: center;
            z-index: 1;
        }
        .golden-line {
            width: 100%;
            height: 2px;
            background-color: #FDC22D;
            margin: 10px 0;
        }
        .controls h3, .controls select, .controls button {
            color: #000;
            background-color: #FDC22D;
            margin-bottom: 10px;
            padding: 10px;
            font-size: 16px;
            width: 90%;
            border: 1px solid #000;
            font-weight: bold;
            text-align: center;
            border-radius: 3px;
            transition: background-color 0.3s, color 0.3s;
        }
        .controls button:hover, .controls select:hover {
            background-color: #6B4700;
            color: #FDC22D;
        }
        .controls select option {
            background-color: #FFF;
            color: #000;
        }
        .status, .error {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            padding: 5px 10px;
            border-radius: 5px;
            color: red;
        }
    </style>
</head>
<body>
    <canvas id="myCanvas"></canvas>
    <div class="controls">
        <button id="resetButton" onclick="resetMap()">Reset Map</button>
        <div class="golden-line"></div>
        <h3>Tiles:</h3>
        <select id="tileType" onchange="updateButtons()">
            <option value="terrain">Terrain</option>
            <option value="objects">Objects</option>
            <option value="level">Level</option>
        </select>
        <div id="terrainButtons">
            <button onclick="setAction('terrain', 'grass')">Grass</button>
            <button onclick="setAction('terrain', 'sand')">Sand</button>
        </div>
        <div id="objectsButtons" style="display:none;">
            <button onclick="setAction('objects', 'castle')">Castle</button>
            <button onclick="setAction('objects', 'necro')">Necropolis</button>
        </div>
        <div id="levelButtons" style="display:none;">
            <button onclick="setAction('level', '1')">Level 1</button>
            <button onclick="setAction('level', '2')">Level 2</button>
            <button onclick="setAction('level', '3')">Level 3</button>
        </div>
        <button id="exportButton" onclick="exportCanvas()">Export as Image</button>
    </div>
    <script>
        let currentAction = '';
        let currentValue = '';
        const canvas = document.getElementById('myCanvas');
        const ctx = canvas.getContext('2d');
        let hexagons = [];
        const sideLength = 30;
        const xSpacing = 52;
        const ySpacing = 45;

        const images = {
            grass: new Image(),
            sand: new Image(),
            castle: new Image(),
            necro: new Image()
        };

        images.grass.src = 'assets/grass.png';
        images.sand.src = 'assets/sand.png';
        images.castle.src = 'assets/castle.png';
        images.necro.src = 'assets/necro.png';

        window.onload = () => {
            resizeCanvas();
            loadImages();
        };
        window.onresize = resizeCanvas;

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            initializeHexagons();
            loadHexagonsFromStorage();
            drawHexagonalGrid(true);
        }

        function initializeHexagons() {
            hexagons = [];
            const numRows = Math.floor(canvas.height / ySpacing);
            const numHexPerRow = Math.floor(canvas.width / xSpacing);

            for (let row = 0; row < numRows; row++) {
                for (let col = 0; col < numHexPerRow; col++) {
                    hexagons.push({
                        x: col * xSpacing + ((row % 2) * xSpacing / 2),
                        y: row * ySpacing,
                        terrain: 'none',
                        objects: 'none',
                        level: '0'
                    });
                }
            }
        }

        function drawHexagonalGrid(drawGrid) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            hexagons.forEach(hex => {
                if (drawGrid) drawGridLines(hex.x, hex.y);
                drawImageLayer(hex.terrain, hex.x, hex.y);
                drawImageLayer(hex.objects, hex.x, hex.y);
            });
        }

        function drawGridLines(x, y) {
            const points = [];
            for (let i = 0; i < 6; i++) {
                const angle = Math.PI / 3 * i - Math.PI / 6;
                points.push({
                    x: x + sideLength * Math.cos(angle),
                    y: y + sideLength * Math.sin(angle)
                });
            }

            ctx.beginPath();
            points.forEach((point, index) => {
                if (index === 0) ctx.moveTo(point.x, point.y);
                else ctx.lineTo(point.x, point.y);
            });
            ctx.closePath();
            ctx.strokeStyle = 'lightgray';
            ctx.stroke();
        }

        function drawImageLayer(type, x, y) {
            if (type !== 'none') {
                const img = images[type];
                ctx.drawImage(img, x - sideLength, y - sideLength, sideLength * 2, sideLength * 2);
            }
        }

        function exportCanvas() {
            drawHexagonalGrid(false); // Draw without grid
            const dataURL = canvas.toDataURL('image/png');
            drawHexagonalGrid(true); // Redraw with grid
            
            const link = document.createElement('a');
            link.download = 'exported_image.png';
            link.href = dataURL;
            link.click();
        }

        function setAction(action, value) {
            currentAction = action;
            currentValue = value;
        }

        function loadImages() {
            const promises = [];
            for (const key in images) {
                const img = images[key];
                promises.push(new Promise((resolve) => {
                    img.onload = resolve;
                }));
            }
            Promise.all(promises).then(() => {
                drawHexagonalGrid(true); // Redraw with images once loaded
            });
        }

        function updateButtons() {
            const tileType = document.getElementById('tileType').value;
            document.getElementById('terrainButtons').style.display = (tileType === 'terrain') ? 'block' : 'none';
            document.getElementById('objectsButtons').style.display = (tileType === 'objects') ? 'block' : 'none';
            document.getElementById('levelButtons').style.display = (tileType === 'level') ? 'block' : 'none';
        }

        function resetMap() {
            hexagons.forEach(hex => {
                hex.terrain = 'none';
                hex.objects = 'none';
                hex.level = '0';
            });
            drawHexagonalGrid(true);
        }

        function loadHexagonsFromStorage() {
            const savedHexagons = localStorage.getItem('hexagons');
            if (savedHexagons) {
                hexagons = JSON.parse(savedHexagons);
                drawHexagonalGrid(true); // Redraw to reflect stored state
            }
        }
    </script>
    <div id="status" class="status"></div>
</body>
</html>
